#!/bin/sh
# Pre-commit hook for lightweight checks
# This runs before each commit to catch issues early

echo "ğŸ” Running pre-commit checks..."

# Check if npm is available
if ! command -v npm &> /dev/null; then
    echo "âŒ npm is not installed. Please install Node.js and npm."
    exit 1
fi

# Run TypeScript type checking
echo "ğŸ“ Running TypeScript type checking..."
npm run lint --silent
if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type checking failed. Please fix the errors before committing."
    exit 1
fi

# Run tests for staged files
echo "ğŸ§ª Running tests..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js)$' || true)

if [ -n "$STAGED_FILES" ]; then
    # Run tests related to changed files
    npm test -- --bail --findRelatedTests $STAGED_FILES --passWithNoTests
    if [ $? -ne 0 ]; then
        echo "âŒ Tests failed. Please fix the tests before committing."
        exit 1
    fi
else
    echo "â„¹ï¸  No TypeScript/JavaScript files staged, skipping tests."
fi

echo "âœ… Pre-commit checks passed!"
exit 0
